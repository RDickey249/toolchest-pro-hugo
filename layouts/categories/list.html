{{ define "main" }}
{{ if eq .RelPermalink "/categories/" }}
    <!-- Main categories page - show all categories in weighted order -->
    <h1>{{ .Title }}</h1>
    {{ if .Description }}
    <p>{{ .Description }}</p>
    {{ end }}
    
    <!-- Collect all category pages and sort by weight -->
    {{ $categoryPages := slice }}
    {{ range where .Site.Pages "Type" "categories" }}
        {{ if and .Params.weight (eq (len (split .RelPermalink "/")) 3) }}
            {{ $categoryPages = $categoryPages | append . }}
        {{ end }}
    {{ end }}
    
    <div class="categories-grid">
        {{ range $categoryPages | sort "Params.weight" }}
        <div class="category-card">
            <h2><a href="{{ .Permalink }}">{{ .Title }}</a></h2>
            <p class="category-description">{{ .Params.description | truncate 120 }}</p>
            
            <!-- Show subcategories -->
            {{ $subcategories := slice }}
            {{ $toolCount := 0 }}
            {{ range where $.Site.Pages ".Type" "categories" }}
                {{ if hasPrefix .RelPermalink (printf "%s" $.RelPermalink) }}
                    {{ if gt (len (split .RelPermalink "/")) 4 }}
                        {{ $subcategories = $subcategories | append . }}
                    {{ end }}
                {{ end }}
            {{ end }}
            
            <!-- Count tools in this category -->
            {{ range $.Site.Pages }}
                {{ if and .Params.category (eq .Params.category $.Title) }}
                    {{ $toolCount = add $toolCount 1 }}
                {{ end }}
            {{ end }}
            
            {{ if $subcategories }}
            <div class="subcategories">
                <strong>Subcategories:</strong>
                <ul>
                    {{ range first 5 ($subcategories | sort "Title") }}
                    <li>{{ .Title }}</li>
                    {{ end }}
                    {{ if gt (len $subcategories) 5 }}
                    <li>... and {{ sub (len $subcategories) 5 }} more</li>
                    {{ end }}
                </ul>
            </div>
            {{ end }}
            
            <p class="tool-count">{{ $toolCount }} tools</p>
        </div>
        {{ end }}
    </div>
{{ else }}
    <!-- Individual category taxonomy pages - show subcategories -->
    <h1>{{ .Title }}</h1>
    
    <!-- Collect unique subcategories -->
    {{ $subcategories := slice }}
    {{ range .Pages }}
        {{ if .Params.subcategories }}
            {{ range .Params.subcategories }}
                {{ if not (in $subcategories .) }}
                    {{ $subcategories = $subcategories | append . }}
                {{ end }}
            {{ end }}
        {{ end }}
    {{ end }}
    
    <ul class="posts-list">
        {{ range $subcategories }}
        <li class="posts-list-item">
            <h2><a href="#{{ . | urlize }}">{{ . }}</a></h2>
            <!-- Count tools in this subcategory -->
            {{ $currentSubcat := . }}
            {{ $toolCount := 0 }}
            {{ range $.Pages }}
                {{ if .Params.subcategories }}
                    {{ if in .Params.subcategories $currentSubcat }}
                        {{ $toolCount = add $toolCount 1 }}
                    {{ end }}
                {{ end }}
            {{ end }}
            <p>{{ $toolCount }} tools</p>
        </li>
        {{ end }}
    </ul>
    
    <!-- Show tools grouped by subcategory -->
    {{ range $subcatName := $subcategories }}
    <h2 id="{{ $subcatName | urlize }}">{{ $subcatName }}</h2>
    <ul class="posts-list">
        {{ range $.Pages }}
            {{ if .Params.subcategories }}
                {{ if in .Params.subcategories $subcatName }}
                <li class="posts-list-item">
                    <h3><a href="{{ .Permalink }}">{{ .Title }}</a></h3>
                    <p>{{ .Params.tagline | default .Summary | truncate 100 }}</p>
                </li>
                {{ end }}
            {{ end }}
        {{ end }}
    </ul>
    {{ end }}
{{ end }}
{{ end }}