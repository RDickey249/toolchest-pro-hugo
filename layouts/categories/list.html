{{ define "main" }}
{{ if eq .RelPermalink "/categories/" }}
    <!-- Main categories page - show ONLY main categories -->
    <h1>{{ .Title }}</h1>
    {{ if .Description }}
    <p>{{ .Description }}</p>
    {{ end }}
    
    <ul class="posts-list">
        {{ range $categoryName, $taxonomy := .Site.Taxonomies.categories }}
        {{ $categoryPage := index $taxonomy 0 }}
        <li class="posts-list-item">
            <h2><a href="{{ "/categories/" | relURL }}{{ $categoryName | urlize }}/">{{ $categoryPage.Params.category | default $categoryName }}</a></h2>
            <p>{{ len $taxonomy }} tools</p>
            {{ if $categoryPage.Params.description }}
            <p>{{ $categoryPage.Params.description | truncate 100 }}</p>
            {{ end }}
        </li>
        {{ end }}
    </ul>
{{ else }}
    <!-- Individual category taxonomy pages - show subcategories -->
    <h1>{{ .Title }}</h1>
    
    <!-- Collect unique subcategories -->
    {{ $subcategories := slice }}
    {{ range .Pages }}
        {{ if .Params.subcategories }}
            {{ range .Params.subcategories }}
                {{ if not (in $subcategories .) }}
                    {{ $subcategories = $subcategories | append . }}
                {{ end }}
            {{ end }}
        {{ end }}
    {{ end }}
    
    <ul class="posts-list">
        {{ range $subcategories }}
        <li class="posts-list-item">
            <h2><a href="#{{ . | urlize }}">{{ . }}</a></h2>
            <!-- Count tools in this subcategory -->
            {{ $currentSubcat := . }}
            {{ $toolCount := 0 }}
            {{ range $.Pages }}
                {{ if .Params.subcategories }}
                    {{ if in .Params.subcategories $currentSubcat }}
                        {{ $toolCount = add $toolCount 1 }}
                    {{ end }}
                {{ end }}
            {{ end }}
            <p>{{ $toolCount }} tools</p>
        </li>
        {{ end }}
    </ul>
    
    <!-- Show tools grouped by subcategory -->
    {{ range $subcatName := $subcategories }}
    <h2 id="{{ $subcatName | urlize }}">{{ $subcatName }}</h2>
    <ul class="posts-list">
        {{ range $.Pages }}
            {{ if .Params.subcategories }}
                {{ if in .Params.subcategories $subcatName }}
                <li class="posts-list-item">
                    <h3><a href="{{ .Permalink }}">{{ .Title }}</a></h3>
                    <p>{{ .Params.tagline | default .Summary | truncate 100 }}</p>
                </li>
                {{ end }}
            {{ end }}
        {{ end }}
    </ul>
    {{ end }}
{{ end }}
{{ end }}