{{ define "main" }}
{{ if eq .RelPermalink "/categories/" }}
    <!-- Main categories page - tank-simple grid of all categories -->
    <div class="breadcrumb">
        <a href="/">Home</a> > <span>Categories</span>
    </div>
    
    <h1>{{ .Title }}</h1>
    {{ if .Description }}
    <p class="page-description">{{ .Description }}</p>
    {{ end }}
    
    <div class="grid grid-3" data-premium-zone="categories-grid">
        {{ range $categoryName, $taxonomy := .Site.Taxonomies.categories }}
        {{ $categoryPage := index $taxonomy 0 }}
        <div class="card category-card" data-premium-zone="category-card">
            <h2><a href="{{ "/categories/" | relURL }}{{ $categoryName | urlize }}/">{{ $categoryPage.Params.category | default $categoryName }}</a></h2>
            <p class="category-description">{{ $categoryPage.Params.tagline | default $categoryPage.Summary | truncate 120 }}</p>
            <p class="tool-count">{{ len $taxonomy }} tools</p>
            
            {{ if ge (len $taxonomy) 3 }}
            <div class="sample-tools">
                <strong>Sample tools:</strong>
                {{ range first 3 $taxonomy }}
                {{ .Title }}{{ if not (eq . (index (first 3 $taxonomy) 2)) }}, {{ end }}
                {{ end }}
                {{ if gt (len $taxonomy) 3 }}...{{ end }}
            </div>
            {{ end }}
            <span class="premium-category-hook" data-premium-zone="category-overlay" style="display: none;"></span>
        </div>
        {{ end }}
    </div>
{{ else }}
    <!-- Individual category page - show subcategories and tools -->
    <div class="breadcrumb">
        <a href="/">Home</a> > <a href="/categories/">Categories</a> > <span>{{ .Title }}</span>
    </div>
    
    <h1>{{ .Title }}</h1>
    {{ if .Description }}
    <p class="page-description">{{ .Description }}</p>
    {{ end }}
    
    <!-- Find all subcategories in this category -->
    {{ $subcategories := dict }}
    {{ range .Pages }}
        {{ if .Params.subcategory }}
            {{ $subcat := .Params.subcategory }}
            {{ $tools := index $subcategories $subcat | default slice }}
            {{ $tools = $tools | append . }}
            {{ $subcategories = merge $subcategories (dict $subcat $tools) }}
        {{ end }}
    {{ end }}
    
    <!-- Show subcategories as cards -->
    {{ if gt (len $subcategories) 0 }}
    <h2>Subcategories</h2>
    <div class="grid grid-2" data-premium-zone="subcategories-grid">
        {{ range $subcatName, $tools := $subcategories }}
        <div class="card subcategory-card" data-premium-zone="subcategory-card">
            <h3><a href="#{{ $subcatName | urlize }}">{{ $subcatName }}</a></h3>
            <p class="tool-count">{{ len $tools }} tools</p>
            <div class="sample-tools">
                {{ range first 3 $tools }}
                {{ .Title }}{{ if not (eq . (index (first 3 $tools) 2)) }}, {{ end }}
                {{ end }}
                {{ if gt (len $tools) 3 }}...{{ end }}
            </div>
            <span class="premium-subcat-hook" data-premium-zone="subcat-overlay" style="display: none;"></span>
        </div>
        {{ end }}
    </div>
    
    <!-- Show tools grouped by subcategory -->
    {{ range $subcatName, $tools := $subcategories }}
    <section id="{{ $subcatName | urlize }}" class="subcategory-section">
        <h2>{{ $subcatName }}</h2>
        <div class="grid grid-3" data-premium-zone="tools-grid">
            {{ range $tools }}
            <div class="card tool-card" data-premium-zone="tool-card">
                <h3><a href="{{ .RelPermalink }}">{{ .Title }}</a></h3>
                <p class="tool-tagline">{{ .Params.tagline | default .Summary | truncate 100 }}</p>
                <span class="premium-tool-hook" data-premium-zone="tool-overlay" style="display: none;"></span>
            </div>
            {{ end }}
        </div>
    </section>
    {{ end }}
    {{ else }}
    <!-- Show all tools if no subcategories -->
    <div class="grid grid-3" data-premium-zone="tools-grid">
        {{ range .Pages }}
        <div class="card tool-card" data-premium-zone="tool-card">
            <h3><a href="{{ .RelPermalink }}">{{ .Title }}</a></h3>
            <p class="tool-tagline">{{ .Params.tagline | default .Summary | truncate 100 }}</p>
            <span class="premium-tool-hook" data-premium-zone="tool-overlay" style="display: none;"></span>
        </div>
        {{ end }}
    </div>
    {{ end }}
{{ end }}
{{ end }}